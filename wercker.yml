box: debian

command-timeout: 60

build:
    steps:
        - script:
            name: install packages
            code: |
                apt-get -qq update
                apt-get -y install git build-essential zlib1g-dev libreadline-dev libncurses-dev libxt-dev libopenmpi-dev openmpi-bin wget cmake petsc-dev gfortran python bison flex python-pip lcov
                pip install codecov
        - script:
            name: boost
            code: |
                export METIS_VERSION=5.1.0
                export PARMETIS_VERSION=4.0.3
                export DEALII_VERSION=8.3.0
                export BOOST_VERSION=1_55_0
                export BOOST_VERSION_DOT=1.55.0

                wget -O boost_${BOOST_VERSION}.tar.bz2 http://downloads.sourceforge.net/project/boost/boost/${BOOST_VERSION_DOT}/boost_${BOOST_VERSION}.tar.bz2
                tar jxf boost_${BOOST_VERSION}.tar.bz2
                rm -f boost_${BOOST_VERSION}.tar.bz2
                ln -s boost_${BOOST_VERSION} boost
        - script:
            name: eigen
            code: |
                wget http://bitbucket.org/eigen/eigen/get/3.2.8.tar.bz2
                tar jxf 3.2.8.tar.bz2
                rm -f 3.2.8.tar.bz2
                ln -s eigen-eigen-07105f7124f9 eigen
        - script:
            name: metis
            code: |
                export METIS_VERSION=5.1.0

                wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/metis/metis-${METIS_VERSION}.tar.gz

                tar -zxf metis-${METIS_VERSION}.tar.gz
                rm metis-${METIS_VERSION}.tar.gz

                ln -s metis-${METIS_VERSION} metis

                cd metis-${METIS_VERSION}

                export CC=mpicc
                export CXX=mpicxx

                make config prefix=`pwd`/build

                make install
        - script:
            name: parmetis
            code: |
                export PARMETIS_VERSION=4.0.3

                wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/parmetis/parmetis-${PARMETIS_VERSION}.tar.gz

                tar -zxf parmetis-${PARMETIS_VERSION}.tar.gz
                rm parmetis-${PARMETIS_VERSION}.tar.gz
                ln -s parmetis-${PARMETIS_VERSION} parmetis

                cd parmetis-${PARMETIS_VERSION}

                export CC=mpicc
                export CXX=mpicxx

                make config prefix=`pwd`/build

                make install
        - script:
            name: deal.II
            code: |
                export DEALII_VERSION=8.3.0

                wget https://github.com/dealii/dealii/releases/download/v${DEALII_VERSION}/dealii-${DEALII_VERSION}.tar.gz

                tar -zxf dealii-${DEALII_VERSION}.tar.gz

                ln -s dealii-${DEALII_VERSION} dealii

                rm dealii-${DEALII_VERSION}.tar.gz
                export CC=mpicc
                export CXX=mpicxx
                export F77=mpif77
                export F90=mpif90
                export METIS_DIR=`pwd`/metis
                export PARMETIS_DIR=`pwd`/parmetis

                cd dealii-${DEALII_VERSION}

                mkdir build
                mkdir bin
                cd build

                cmake -DCMAKE_INSTALL_PREFIX=`pwd`/../bin -DCMAKE_BUILD_TYPE="Debug" ..

                make -j 4 install

                make -j 4 test
        - script:
            name: compile deal-fsi
            code: |
                cmake -DDEAL_II_DIR=dealii/bin/ .
                make
        - script:
            name: run test suite with MPI
            code: mpirun -np 2 ./main
        - script:
            name: run test suite
            code: | 
                lcov --directory . --zerocounters # reset code coverage counters
                ./main
        - script:
            name: code coverage
            code: |
                codecov --token=${CODECOV_TOKEN}
